(function(a){a.fn.extend({editCell:function(d,c,b){return this.each(function(){var j=this,m,k,g;if(!j.grid||j.p.cellEdit!==true){return}c=parseInt(c,10);j.p.selrow=j.rows[d].id;if(!j.p.knv){a(j).GridNav()}if(j.p.savedRow.length>0){if(b===true){if(d==j.p.iRow&&c==j.p.iCol){return}}var h=a("td:eq("+j.p.savedRow[0].ic+")>#"+j.p.savedRow[0].id+"_"+j.p.savedRow[0].name.replace(".","\\."),j.rows[j.p.savedRow[0].id]).val();if(j.p.savedRow[0].v!=h){a(j).saveCell(j.p.savedRow[0].id,j.p.savedRow[0].ic)}else{a(j).restoreCell(j.p.savedRow[0].id,j.p.savedRow[0].ic)}}else{window.setTimeout(function(){a("#"+j.p.knv).attr("tabindex","-1").focus()},0)}m=j.p.colModel[c].name;if(m=="subgrid"||m=="cb"||m=="rn"){return}if(j.p.colModel[c].editable===true&&b===true){g=a("td:eq("+c+")",j.rows[d]);if(parseInt(j.p.iCol)>=0&&parseInt(j.p.iRow)>=0){a("td:eq("+j.p.iCol+")",j.rows[j.p.iRow]).removeClass("edit-cell ui-state-highlight");a(j.rows[j.p.iRow]).removeClass("selected-row ui-state-hover")}a(g).addClass("edit-cell ui-state-highlight");a(j.rows[d]).addClass("selected-row ui-state-hover");try{k=a.unformat(g,{colModel:j.p.colModel[c]},c)}catch(l){k=a(g).html()}if(!j.p.colModel[c].edittype){j.p.colModel[c].edittype="text"}j.p.savedRow.push({id:d,ic:c,name:m,v:k});if(a.isFunction(j.p.formatCell)){var i=j.p.formatCell(j.rows[d].id,m,k,d,c);if(i){k=i}}var f=a.extend({},j.p.colModel[c].editoptions||{},{id:d+"_"+m,name:m});var e=createEl(j.p.colModel[c].edittype,f,k,true);if(a.isFunction(j.p.beforeEditCell)){j.p.beforeEditCell(j.rows[d].id,m,k,d,c)}a(g).html("").append(e).attr("tabindex","0");window.setTimeout(function(){a(e).focus()},0);a("input, select, textarea",g).bind("keydown",function(n){if(n.keyCode===27){a(j).restoreCell(d,c)}if(n.keyCode===13){a(j).saveCell(d,c)}if(n.keyCode==9){if(n.shiftKey){a(j).prevCell(d,c)}else{a(j).nextCell(d,c)}}n.stopPropagation()});if(a.isFunction(j.p.afterEditCell)){j.p.afterEditCell(j.rows[d].id,m,k,d,c)}}else{if(parseInt(j.p.iCol)>=0&&parseInt(j.p.iRow)>=0){a("td:eq("+j.p.iCol+")",j.rows[j.p.iRow]).removeClass("edit-cell ui-state-highlight");a(j.rows[j.p.iRow]).removeClass("selected-row ui-state-hover")}a("td:eq("+c+")",j.rows[d]).addClass("edit-cell ui-state-highlight");a(j.rows[d]).addClass("selected-row ui-state-hover");if(a.isFunction(j.p.onSelectCell)){k=a("td:eq("+c+")",j.rows[d]).html().replace(/\&nbsp\;/ig,"");j.p.onSelectCell(j.rows[d].id,m,k,d,c)}}j.p.iCol=c;j.p.iRow=d})},saveCell:function(c,b){return this.each(function(){var j=this,l;if(!j.grid||j.p.cellEdit!==true){return}if(j.p.savedRow.length>=1){l=0}else{l=null}if(l!=null){var g=a("td:eq("+b+")",j.rows[c]),q,o,r=j.p.colModel[b].name.replace(".","\\.");switch(j.p.colModel[b].edittype){case"select":if(!j.p.colModel[b].editoptions.multiple){q=a("#"+c+"_"+r+">option:selected",j.rows[c]).val();o=a("#"+c+"_"+r+">option:selected",j.rows[c]).text()}else{var d=a("#"+c+"_"+r,j.rows[c]),f=[];q=a(d).val();if(q){q.join(",")}else{q=""}a("option:selected",d).each(function(e,s){f[e]=a(s).text()});o=f.join(",")}if(j.p.colModel[b].formatter){o=q}break;case"checkbox":var h=["Yes","No"];if(j.p.colModel[b].editoptions){h=j.p.colModel[b].editoptions.value.split(":")}q=a("#"+c+"_"+r.replace(".","\\."),j.rows[c]).attr("checked")?h[0]:h[1];o=q;break;case"password":case"text":case"textarea":case"button":q=!j.p.autoencode?a("#"+c+"_"+r.replace(".","\\."),j.rows[c]).val():a.jgrid.htmlEncode(a("#"+c+"_"+r.replace(".","\\."),j.rows[c]).val());o=q;break}if(o!=j.p.savedRow[l].v){if(a.isFunction(j.p.beforeSaveCell)){var p=j.p.beforeSaveCell(j.rows[c].id,r,q,c,b);if(p){q=p}}var i=checkValues(q,b,j);if(i[0]===true){var k={};if(a.isFunction(j.p.beforeSubmitCell)){k=j.p.beforeSubmitCell(j.rows[c].id,r,q,c,b);if(!k){k={}}}if(o==""){o=" "}if(j.p.cellsubmit=="remote"){if(j.p.cellurl){var n={};n[r]=q;n.id=j.rows[c].id;n=a.extend(k,n);a.ajax({url:j.p.cellurl,data:n,type:"POST",complete:function(e,t){if(t=="success"){if(a.isFunction(j.p.afterSubmitCell)){var s=j.p.afterSubmitCell(e,n.id,r,q,c,b);if(s[0]===true){a(g).empty();a(j).setCell(j.rows[c].id,b,o);a(g).addClass("dirty-cell");a(j.rows[c]).addClass("edited");if(a.isFunction(j.p.afterSaveCell)){j.p.afterSaveCell(j.rows[c].id,r,q,c,b)}j.p.savedRow.splice(0,1)}else{info_dialog(a.jgrid.errors.errcap,s[1],a.jgrid.edit.bClose);a(j).restoreCell(c,b)}}else{a(g).empty();a(j).setCell(j.rows[c].id,b,o);a(g).addClass("dirty-cell");a(j.rows[c]).addClass("edited");if(a.isFunction(j.p.afterSaveCell)){j.p.afterSaveCell(j.rows[c].id,r,q,c,b)}j.p.savedRow.splice(0,1)}}},error:function(e,s){if(a.isFunction(j.p.errorCell)){j.p.errorCell(e,s);a(j).restoreCell(c,b)}else{info_dialog(a.jgrid.errors.errcap,e.status+" : "+e.statusText+"<br/>"+s,a.jgrid.edit.bClose);a(j).restoreCell(c,b)}}})}else{try{info_dialog(a.jgrid.errors.errcap,a.jgrid.errors.nourl,a.jgrid.edit.bClose);a(j).restoreCell(c,b)}catch(m){}}}if(j.p.cellsubmit=="clientArray"){a(g).empty();a(j).setCell(j.rows[c].id,b,o);a(g).addClass("dirty-cell");a(j.rows[c]).addClass("edited");if(a.isFunction(j.p.afterSaveCell)){j.p.afterSaveCell(j.rows[c].id,r,q,c,b)}j.p.savedRow.splice(0,1)}}else{try{window.setTimeout(function(){info_dialog(a.jgrid.errors.errcap,q+" "+i[1],a.jgrid.edit.bClose)},100);a(j).restoreCell(c,b)}catch(m){}}}else{a(j).restoreCell(c,b)}}if(a.browser.opera){a("#"+j.p.knv).attr("tabindex","-1").focus()}else{window.setTimeout(function(){a("#"+j.p.knv).attr("tabindex","-1").focus()},0)}})},restoreCell:function(c,b){return this.each(function(){var h=this,d;if(!h.grid||h.p.cellEdit!==true){return}if(h.p.savedRow.length>=1){d=0}else{d=null}if(d!=null){var g=a("td:eq("+b+")",h.rows[c]);if(a.isFunction(a.fn.datepicker)){try{a.datepicker("hide")}catch(f){try{a.datepicker.hideDatepicker()}catch(f){}}}a(g).empty().attr("tabindex","-1");a(h).setCell(h.rows[c].id,b,h.p.savedRow[d].v);h.p.savedRow.splice(0,1)}window.setTimeout(function(){a("#"+h.p.knv).attr("tabindex","-1").focus()},0)})},nextCell:function(c,b){return this.each(function(){var f=this,e=false;if(!f.grid||f.p.cellEdit!==true){return}for(var d=b+1;d<f.p.colModel.length;d++){if(f.p.colModel[d].editable===true){e=d;break}}if(e!==false){a(f).editCell(c,e,true)}else{if(f.p.savedRow.length>0){a(f).saveCell(c,b)}}})},prevCell:function(c,b){return this.each(function(){var f=this,e=false;if(!f.grid||f.p.cellEdit!==true){return}for(var d=b-1;d>=0;d--){if(f.p.colModel[d].editable===true){e=d;break}}if(e!==false){a(f).editCell(c,e,true)}else{if(f.p.savedRow.length>0){a(f).saveCell(c,b)}}})},GridNav:function(){return this.each(function(){var f=this;if(!f.grid||f.p.cellEdit!==true){return}f.p.knv=a("table:first",f.grid.bDiv).attr("id")+"_kn";var e=a("<span style='width:0px;height:0px;background-color:black;' tabindex='0'><span tabindex='-1' style='width:0px;height:0px;background-color:grey' id='"+f.p.knv+"'></span></span>"),c;a(e).insertBefore(f.grid.cDiv);a("#"+f.p.knv).focus();a("#"+f.p.knv).keydown(function(g){switch(g.keyCode){case 38:if(f.p.iRow-1>=0){d(f.p.iRow-1,f.p.iCol,"vu");a(f).editCell(f.p.iRow-1,f.p.iCol,false)}break;case 40:if(f.p.iRow+1<=f.rows.length-1){d(f.p.iRow+1,f.p.iCol,"vd");a(f).editCell(f.p.iRow+1,f.p.iCol,false)}break;case 37:if(f.p.iCol-1>=0){c=b(f.p.iCol-1,"lft");d(f.p.iRow,c,"h");a(f).editCell(f.p.iRow,c,false)}break;case 39:if(f.p.iCol+1<=f.p.colModel.length-1){c=b(f.p.iCol+1,"rgt");d(f.p.iRow,c,"h");a(f).editCell(f.p.iRow,c,false)}break;case 13:if(parseInt(f.p.iCol,10)>=0&&parseInt(f.p.iRow,10)>=0){a(f).editCell(f.p.iRow,f.p.iCol,true)}break}return false});function d(o,m,n){if(n.substr(0,1)=="v"){var g=a(f.grid.bDiv)[0].clientHeight,p=a(f.grid.bDiv)[0].scrollTop,q=f.rows[o].offsetTop+f.rows[o].clientHeight,k=f.rows[o].offsetTop;if(n=="vd"){if(q>=g){a(f.grid.bDiv)[0].scrollTop=a(f.grid.bDiv)[0].scrollTop+f.rows[o].clientHeight}}if(n=="vu"){if(k<p){a(f.grid.bDiv)[0].scrollTop=a(f.grid.bDiv)[0].scrollTop-f.rows[o].clientHeight}}}if(n=="h"){var j=a(f.grid.bDiv)[0].clientWidth,i=a(f.grid.bDiv)[0].scrollLeft,h=f.rows[o].cells[m].offsetLeft+f.rows[o].cells[m].clientWidth,l=f.rows[o].cells[m].offsetLeft;if(h>=j+parseInt(i)){a(f.grid.bDiv)[0].scrollLeft=a(f.grid.bDiv)[0].scrollLeft+f.rows[o].cells[m].clientWidth}else{if(l<i){a(f.grid.bDiv)[0].scrollLeft=a(f.grid.bDiv)[0].scrollLeft-f.rows[o].cells[m].clientWidth}}}}function b(k,g){var j,h;if(g=="lft"){j=k+1;for(h=k;h>=0;h--){if(f.p.colModel[h].hidden!==true){j=h;break}}}if(g=="rgt"){j=k-1;for(h=k;h<f.p.colModel.length;h++){if(f.p.colModel[h].hidden!==true){j=h;break}}}return j}})},getChangedCells:function(c){var b=[];if(!c){c="all"}this.each(function(){var e=this,d;if(!e.grid||e.p.cellEdit!==true){return}a(e.rows).each(function(f){var g={};if(a(this).hasClass("edited")){a("td",this).each(function(h){d=e.p.colModel[h].name;if(d!=="cb"&&d!=="subgrid"){if(c=="dirty"){if(a(this).hasClass("dirty-cell")){g[d]=a.jgrid.htmlDecode(a(this).html())}}else{g[d]=a.jgrid.htmlDecode(a(this).html())}}});g.id=this.id;b.push(g)}})});return b}})})(jQuery);