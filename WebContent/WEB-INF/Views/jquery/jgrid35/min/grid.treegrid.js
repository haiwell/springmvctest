(function(a){a.fn.extend({setTreeNode:function(b,c){return this.each(function(){var g=this;if(!g.grid||!g.p.treeGrid){return}var j=g.p.expColInd;var i=g.p.treeReader.expanded_field;var f=g.p.treeReader.leaf_field;var e=g.p.treeReader.level_field;c.level=b[e];if(g.p.treeGridModel=="nested"){c.lft=b[g.p.treeReader.left_field];c.rgt=b[g.p.treeReader.right_field];if(!b[f]){b[f]=(parseInt(c.rgt,10)===parseInt(c.lft,10)+1)?"true":"false"}}else{c.parent_id=b[g.p.treeReader.parent_id_field]}var k=parseInt(c.level,10),h,l;if(g.p.tree_root_level===0){h=k+1;l=k}else{h=k;l=k-1}var d="<div class='tree-wrap' style='width:"+(h*18)+"px;'>";d+="<div style='left:"+(l*18)+"px;' class='ui-icon ";if(b[f]=="true"||b[f]==true){d+=g.p.treeIcons.leaf+" tree-leaf'";c.isLeaf=true}else{if(b[i]=="true"||b[i]==true){d+=g.p.treeIcons.minus+" tree-minus treeclick'";c.expanded=true}else{d+=g.p.treeIcons.plus+" tree-plus treeclick'";c.expanded=false}c.isLeaf=false}d+="</div></div>";if(parseInt(b[e],10)!==parseInt(g.p.tree_root_level,10)){if(!a(g).isVisibleNode(c)){a(c).css("display","none")}}a("td:eq("+j+")",c).wrapInner("<span></span>").prepend(d);a(".treeclick",c).bind("click",function(o){var n=o.target||o.srcElement;var m=a(n,g.rows).parents("tr.jqgrow")[0].rowIndex;if(!g.rows[m].isLeaf){if(g.rows[m].expanded){a(g).collapseRow(g.rows[m]);a(g).collapseNode(g.rows[m])}else{a(g).expandRow(g.rows[m]);a(g).expandNode(g.rows[m])}}return false});if(g.p.ExpandColClick===true){a("span",c).css("cursor","pointer").bind("click",function(o){var n=o.target||o.srcElement;var m=a(n,g.rows).parents("tr.jqgrow")[0].rowIndex;if(!g.rows[m].isLeaf){if(g.rows[m].expanded){a(g).collapseRow(g.rows[m]);a(g).collapseNode(g.rows[m])}else{a(g).expandRow(g.rows[m]);a(g).expandNode(g.rows[m])}}a(g).setSelection(g.rows[m].id);return false})}})},setTreeGrid:function(){return this.each(function(){var d=this,c=0;if(!d.p.treeGrid){return}if(!d.p.treedatatype){a.extend(d.p,{treedatatype:d.p.datatype})}d.p.subGrid=false;d.p.altRows=false;d.p.pgbuttons=false;d.p.pginput=false;d.p.multiselect=false;d.p.rowList=[];d.p.treeIcons=a.extend({plus:"ui-icon-triangle-1-e",minus:"ui-icon-triangle-1-s",leaf:"ui-icon-radio-off"},d.p.treeIcons||{});if(d.p.treeGridModel=="nested"){d.p.treeReader=a.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded"},d.p.treeReader)}else{if(d.p.treeGridModel=="adjacency"){d.p.treeReader=a.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded"},d.p.treeReader)}}for(var b in d.p.colModel){if(d.p.colModel[b].name==d.p.ExpandColumn){d.p.expColInd=c;break}c++}if(!d.p.expColInd){d.p.expColInd=0}a.each(d.p.treeReader,function(e,f){if(f){d.p.colNames.push(f);d.p.colModel.push({name:f,width:1,hidden:true,sortable:false,resizable:false,hidedlg:true,editable:true,search:false})}})})},expandRow:function(b){this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}var c=a(d).getNodeChildren(b);a(c).each(function(e){a(this).css("display","");if(this.expanded){a(d).expandRow(this)}})})},collapseRow:function(b){this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}var c=a(d).getNodeChildren(b);a(c).each(function(e){a(this).css("display","none");a(d).collapseRow(this)})})},getRootNodes:function(){var b=[];this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}switch(d.p.treeGridModel){case"nested":var c=d.p.treeReader.level_field;a(d.rows).each(function(e){if(parseInt(this[c],10)===parseInt(d.p.tree_root_level,10)){b.push(this)}});break;case"adjacency":a(d.rows).each(function(e){if(this.parent_id==null||this.parent_id.toLowerCase()=="null"){b.push(this)}});break}});return b},getNodeDepth:function(c){var b=null;this.each(function(){var d=this;if(!this.grid||!this.p.treeGrid){return}switch(d.p.treeGridModel){case"nested":b=parseInt(c.level,10)-parseInt(this.p.tree_root_level,10);break;case"adjacency":b=a(d).getNodeAncestors(c).length;break}});return b},getNodeParent:function(c){var b=null;this.each(function(){var g=this;if(!g.grid||!g.p.treeGrid){return}switch(g.p.treeGridModel){case"nested":var e=parseInt(c.lft,10),d=parseInt(c.rgt,10),f=parseInt(c.level,10);a(this.rows).each(function(){if(parseInt(this.level,10)===f-1&&parseInt(this.lft)<e&&parseInt(this.rgt)>d){b=this;return false}});break;case"adjacency":a(this.rows).each(function(){if(this.id==c.parent_id){b=this;return false}});break}});return b},getNodeChildren:function(c){var b=[];this.each(function(){var g=this;if(!g.grid||!g.p.treeGrid){return}switch(g.p.treeGridModel){case"nested":var e=parseInt(c.lft,10),d=parseInt(c.rgt,10),f=parseInt(c.level,10);a(this.rows).each(function(h){if(parseInt(this.level,10)===f+1&&parseInt(this.lft,10)>e&&parseInt(this.rgt,10)<d){b.push(this)}});break;case"adjacency":a(this.rows).each(function(h){if(this.parent_id==c.id){b.push(this)}});break}});return b},getFullTreeNode:function(c){var b=[];this.each(function(){var g=this;if(!g.grid||!g.p.treeGrid){return}switch(g.p.treeGridModel){case"nested":var e=parseInt(c.lft,10),d=parseInt(c.rgt,10),f=parseInt(c.level,10);a(this.rows).each(function(h){if(parseInt(this.level,10)>=f&&parseInt(this.lft,10)>=e&&parseInt(this.lft,10)<=d){b.push(this)}});break;case"adjacency":b.push(c);a(this.rows).each(function(h){len=b.length;for(h=0;h<len;h++){if(b[h].id==this.parent_id){b.push(this);break}}});break}});return b},getNodeAncestors:function(c){var b=[];this.each(function(){if(!this.grid||!this.p.treeGrid){return}var d=a(this).getNodeParent(c);while(d){b.push(d);d=a(this).getNodeParent(d)}});return b},isVisibleNode:function(c){var b=true;this.each(function(){var e=this;if(!e.grid||!e.p.treeGrid){return}var d=a(e).getNodeAncestors(c);a(d).each(function(){b=b&&this.expanded;if(!b){return false}})});return b},isNodeLoaded:function(c){var b;this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}if(c.loaded!==undefined){b=c.loaded}else{if(c.isLeaf||a(d).getNodeChildren(c).length>0){b=true}else{b=false}}});return b},expandNode:function(b){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}if(!b.expanded){if(a(this).isNodeLoaded(b)){b.expanded=true;a("div.treeclick",b).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus")}else{b.expanded=true;a("div.treeclick",b).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus");this.p.treeANode=b.rowIndex;this.p.datatype=this.p.treedatatype;if(this.p.treeGridModel=="nested"){a(this).setGridParam({postData:{nodeid:b.id,n_left:b.lft,n_right:b.rgt,n_level:b.level}})}else{a(this).setGridParam({postData:{nodeid:b.id,parentid:b.parent_id,n_level:b.level}})}a(this).trigger("reloadGrid");if(this.p.treeGridModel=="nested"){a(this).setGridParam({postData:{nodeid:"",n_left:"",n_right:"",n_level:""}})}else{a(this).setGridParam({postData:{nodeid:"",parentid:"",n_level:""}})}}}})},collapseNode:function(b){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}if(b.expanded){b.expanded=false;a("div.treeclick",b).removeClass(this.p.treeIcons.minus+" tree-minus").addClass(this.p.treeIcons.plus+" tree-plus")}})},SortTree:function(b){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var f,c,g,e=[],h=this,d=a(this).getRootNodes();d.sort(function(j,i){if(j.sortKey<i.sortKey){return -b}if(j.sortKey>i.sortKey){return b}return 0});if(d[0]){a("td",d[0]).each(function(i){a(this).css("width",h.grid.headers[i].width+"px")});h.grid.cols=d[0].cells}for(f=0,c=d.length;f<c;f++){g=d[f];e.push(g);a(this).collectChildrenSortTree(e,g,b)}a.each(e,function(i,j){a("tbody",h.grid.bDiv).append(j);j.sortKey=null})})},collectChildrenSortTree:function(b,d,c){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var g,e,h,f=a(this).getNodeChildren(d);f.sort(function(j,i){if(j.sortKey<i.sortKey){return -c}if(j.sortKey>i.sortKey){return c}return 0});for(g=0,e=f.length;g<e;g++){h=f[g];b.push(h);a(this).collectChildrenSortTree(b,h,c)}})},setTreeRow:function(c,d){var b,e=false;this.each(function(){var f=this;if(!f.grid||!f.p.treeGrid){return}e=a(f).setRowData(c,d)});return e},delTreeNode:function(b){return this.each(function(){var f=this;if(!f.grid||!f.p.treeGrid){return}var d=a(f).getInd(b,true);if(d){var e=a(f).getNodeChildren(d);if(e.length>0){for(var c=0;c<e.length;c++){a(f).delRowData(e[c].id)}}a(f).delRowData(d.id)}})}})})(jQuery);